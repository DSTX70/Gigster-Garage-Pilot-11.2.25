#!/usr/bin/env bash
set -euo pipefail

PROJECT_KEY="${PROJECT_KEY:-GigsterGarage}"
EXPORTS_DIR="${EXPORTS_DIR:-exports}"
POST_VERIFY_LIMIT="${POST_VERIFY_LIMIT:-10}"

# DRIVE_STEWARD_URL is required for the post-verify call
if [[ -z "${DRIVE_STEWARD_URL:-}" ]]; then
  echo "FAIL ❌ DRIVE_STEWARD_URL is not set (needed for post-verify)."
  exit 1
fi

BASE_URL="${DRIVE_STEWARD_URL%/}"

echo "SHIP PUBLISH: ${PROJECT_KEY}"

# 1) Dry gate (build bundle)
bash tools/ci_gate.sh

# 2) Publish to Drive Steward
PROJECT_KEY="$PROJECT_KEY" npx tsx tools/publish_drive_steward.ts

# 3) Compute SHA256 of newest tar.gz (ground truth)
if ! ls -1 "${EXPORTS_DIR}"/*.tar.gz >/dev/null 2>&1; then
  echo "FAIL ❌ No .tar.gz bundles found in ${EXPORTS_DIR}/ after export."
  exit 1
fi

NEWEST_TAR="$(ls -1t "${EXPORTS_DIR}"/*.tar.gz | head -n 1)"
NEWEST_NAME="$(basename "$NEWEST_TAR")"

NEWEST_SHA="$(python - << 'PY'
import hashlib, sys
p = sys.argv[1]
h = hashlib.sha256()
with open(p, "rb") as f:
  for chunk in iter(lambda: f.read(1024*1024), b""):
    h.update(chunk)
print(h.hexdigest())
PY
"$NEWEST_TAR")"

echo "Post-verify: newest bundle"
echo "  bundle: ${NEWEST_NAME}"
echo "  sha256: ${NEWEST_SHA}"

# 4) Verify it exists in Drive Steward history (unauth endpoint)
HIST_URL="${BASE_URL}/api/exports/history?projectKey=${PROJECT_KEY}&limit=${POST_VERIFY_LIMIT}"
echo "Post-verify: GET ${HIST_URL}"

HIST_JSON="$(curl -sS "${HIST_URL}" || true)"

# Basic sanity: must be JSON and must include the sha
if echo "${HIST_JSON}" | grep -qi "<html"; then
  echo "FAIL ❌ History endpoint returned HTML. Check DRIVE_STEWARD_URL."
  exit 1
fi

if ! echo "${HIST_JSON}" | grep -q "\"ok\":true"; then
  echo "FAIL ❌ History endpoint did not return ok:true"
  echo "${HIST_JSON}"
  exit 1
fi

if ! echo "${HIST_JSON}" | grep -q "${NEWEST_SHA}"; then
  echo "FAIL ❌ Publish completed but SHA not found in Drive Steward history yet."
  echo "Expected SHA: ${NEWEST_SHA}"
  echo "${HIST_JSON}"
  exit 1
fi

echo "Post-verify ✅ SHA found in Drive Steward history."
echo "SHIP PUBLISH DONE ✅"
